<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>User Dashboard - Event Mate AI</title>
  <link rel="stylesheet" href="dashboard.css" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5fbff;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .app-header {
      height: 56px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, #04345c, #00a8ff);
      color: #ffffff;
    }

    .app-main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* LEFT SIDEBAR */
    .sidebar {
      width: 220px;
      background: #ffffff;
      border-right: 1px solid #dde6f2;
      padding: 16px 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-title {
      font-size: 14px;
      font-weight: 600;
      color: #5b7285;
      margin-bottom: 8px;
      padding: 0 6px;
    }

    .nav-btn {
      width: 100%;
      border: none;
      background: transparent;
      text-align: left;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      color: #04345c;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-btn span.icon {
      width: 20px;
      text-align: center;
    }

    .nav-btn.active,
    .nav-btn:hover {
      background: #e6f6ff;
      color: #00a8ff;
    }

    /* MAIN CONTENT AREA */
    .main-content {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
      overflow-y: auto;
      position: relative;
    }

    .placeholder-box {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 8px 22px rgba(4, 52, 92, 0.08);
      padding: 16px 20px;
    }

    .placeholder-title {
      font-size: 18px;
      color: #04345c;
      margin-bottom: 8px;
    }

    .placeholder-text {
      font-size: 14px;
      color: #5b7285;
    }

    .loading-text {
      font-size: 14px;
      color: #5b7285;
      margin-bottom: 8px;
    }

    .error-text {
      font-size: 14px;
      color: #e03a3c;
      margin-bottom: 8px;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <span class="brand-logo-circle">E</span>
        <span class="brand-text">EVENTMATE <span class="brand-ai">AI</span></span>
      </div>
      <div class="profile-dropdown">
        <button class="logout-btn" title="Profile" onclick="window.location.href='user-profile.html'">
          <div class="logout-icon-circle">üë§</div>
          <span>Profile</span>
        </button>
        <div class="dropdown-content">
          <a href="user-dashboard.html">Dashboard</a>
          <a href="user-profile.html">Edit Profile</a>
          <a href="javascript:void(0)" onclick="handleLogout()" class="logout-link">Logout</a>
        </div>
      </div>
    </header>

    <main class="app-main">
      <!-- LEFT PANEL -->
      <aside class="sidebar">
        <div class="sidebar-title">Menu</div>

        <!-- 4 categories -->
        <button class="nav-btn active" id="nav-home" onclick="openPage('home')">
          <span class="icon">üè†</span>
          <span>Home (slides)</span>
        </button>

        <button class="nav-btn" id="nav-events" onclick="openPage('events')">
          <span class="icon">üé´</span>
          <span>Events</span>
        </button>

        <button class="nav-btn" id="nav-booking" onclick="openPage('booking')">
          <span class="icon">üìù</span>
          <span>Booking</span>
        </button>

        <button class="nav-btn" id="nav-mybookings" onclick="openPage('my-bookings')">
          <span class="icon">üìÇ</span>
          <span>My Bookings</span>
        </button>
      </aside>

      <!-- CENTER CONTENT -->
      <section class="main-content" id="mainContent">
        <!-- Default view: slides / home content -->
        <div class="placeholder-box" id="homeContent">
          <h2 class="placeholder-title">Welcome to EventMate AI</h2>
          <p class="placeholder-text">
            Your moving slides / hero carousel can go here. Replace this box with your existing slideshow code.
          </p>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Dynamic API URL - uses environment variable or defaults to localhost
    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:9098' 
      : (window.__API_BASE__ || `${window.location.protocol}//${window.location.host.split('.')[0]}-backend.vercel.app`);

    document.addEventListener('DOMContentLoaded', () => {
      fetchUserName();
    });

    async function fetchUserName() {
      const userId = localStorage.getItem('eventmate_userId');
      if (!userId) return;

      try {
        const res = await fetch(`${API_BASE}/api/users/${userId}`);
        if (res.ok) {
          const data = await res.json();
          const user = data.user || data;
          const btnSpan = document.querySelector('.logout-btn span');
          if (btnSpan && user.fullName) {
            btnSpan.textContent = user.fullName.split(' ')[0]; // Just first name
          }
        }
      } catch (e) { console.warn('Failed to load user name', e); }
    }

    function handleLogout() {
      localStorage.removeItem('eventmate_token');
      localStorage.removeItem('eventmate_role');
      localStorage.removeItem('eventmate_userId');
      window.location.href = 'login.html';
    }

    function setActiveButton(page) {
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      if (page === 'home') document.getElementById('nav-home').classList.add('active');
      if (page === 'events') document.getElementById('nav-events').classList.add('active');
      if (page === 'booking') document.getElementById('nav-booking').classList.add('active');
      if (page === 'my-bookings') document.getElementById('nav-mybookings').classList.add('active');
    }

    // Load an external HTML page into the mainContent div
    async function loadHtmlIntoMain(url) {
      const main = document.getElementById('mainContent');
      // Execute any inline scripts in the loaded HTML
      // Basic fetch only gets text, scripts inside won't run automatically if just setting innerHTML
      // So we must manually execute them.

      main.innerHTML = '<div class="loading-text">Loading...</div>';
      try {
        const res = await fetch(url);
        if (!res.ok) {
          main.innerHTML = '<div class="error-text">Failed to load content.</div>';
          return;
        }
        const html = await res.text();

        // Basic extract: take only body innerHTML to avoid duplicating <html>, <head>
        const temp = document.createElement('div');
        temp.innerHTML = html;

        // Remove scripts from temp so we can run them manually
        const scripts = temp.querySelectorAll('script');
        const scriptContents = [];
        scripts.forEach(s => {
          scriptContents.push(s.innerHTML);
          s.remove();
        });

        const body = temp.querySelector('body');
        main.innerHTML = body ? body.innerHTML : temp.innerHTML;

        // Run scripts
        scriptContents.forEach(code => {
          const script = document.createElement('script');
          script.textContent = code;
          document.body.appendChild(script);
        });

      } catch (err) {
        console.error('Error loading page:', err);
        main.innerHTML = '<div class="error-text">Error connecting to server.</div>';
      }
    }

    function openPage(page) {
      setActiveButton(page);

      if (page === 'home') {
        const main = document.getElementById('mainContent');
        // Check if user-home.html exists and load it? 
        // Or keep the placeholder. The previous file had user-home.html separate. 
        // The original user-home.html IS the dashboard main page in some flows.
        // But here we are in user-dashboard.html loading sub-pages.
        // Let's load 'user-home.html' (which has the slides/grid) if it works as a fragment
        // But user-home.html is a full page. 
        // Let's assume for now we keep the placeholder or try to load user-home.html content.
        // Based on file list, user-home.html exists (44kb). It's likely the "Home" page with events grid.
        loadHtmlIntoMain('user-home.html');

      } else if (page === 'events') {
        loadHtmlIntoMain('user-events.html');
      } else if (page === 'booking') {
        loadHtmlIntoMain('user-booking.html'); // Corrected filename based on list_dir
      } else if (page === 'my-bookings') {
        loadHtmlIntoMain('user-my-bookings.html');
      }
    }
  </script>
</body>

</html>